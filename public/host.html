<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜¸ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ - ìŠˆë¢°ë”©ê±° ê²Œì„</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 1rem; margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .panel { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 1.5rem; border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 100%; max-width: 800px; margin-bottom: 1rem;
        }
        h1, h2, h3 { text-align: center; margin-bottom: 1rem; }
        .room-title { font-size: 2rem; color: white; margin-bottom: 1rem; }
        
        /* --- State-specific containers --- */
        #waitingRoom, #votingRoom, #resultRoom, #gameFinishedRoom { display: none; }

        /* --- Common Elements --- */
        .qr-section { text-align: center; margin-bottom: 1rem; }
        #qrCode { border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .participants-list { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .participants-list li { background: #eee; padding: 8px 12px; border-radius: 8px; }
        .question-display { font-size: 1.5rem; font-weight: bold; margin: 1rem 0; }
        .timer-display { font-size: 2.5rem; font-weight: bold; color: #dc3545; margin-bottom: 1rem; }
        .voter-columns { display: flex; justify-content: space-around; text-align: center; }
        .voter-columns h3 { margin-bottom: 0.5rem; }
        .voter-columns ul { list-style: none; padding: 0; }
        .button-group { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .action-button { 
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); 
            color: white; border: none; padding: 15px 30px; 
            border-radius: 8px; cursor: pointer; font-size: 18px;
            font-weight: 600; transition: all 0.3s;
        }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4); }
        .action-button:disabled { background: #ccc; cursor: not-allowed; }
        .finalize-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .end-early-btn { background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%); }
        #message { text-align: center; margin-top: 1rem; padding: 10px; border-radius: 8px; font-weight: 500; display: none; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1 id="gameTitle" class="room-title"></h1>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="panel">
        <h2>ê²Œì„ ì‹œì‘ ëŒ€ê¸° ì¤‘...</h2>
        <div class="qr-section">
            <p>ì°¸ê°€ìë“¤ì´ ì•„ë˜ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <img id="qrCode" alt="QR Code" />
        </div>
        <h3>ì°¸ê°€ì ëª©ë¡ (<span id="participantCount">0</span>ëª…)</h3>
        <ul id="participantList" class="participants-list"></ul>
        <div class="button-group">
            <button id="startGameBtn" class="action-button">ğŸš€ ê²Œì„ ì‹œì‘!</button>
        </div>
    </div>

    <!-- Voting Room -->
    <div id="votingRoom" class="panel">
        <h2 id="questionHeader"></h2>
        <p id="currentQuestion" class="question-display"></p>
        <div id="timer" class="timer-display"></div>
        <h3>ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™© (<span id="voteCount">0</span>ëª…)</h3>
        <div class="voter-columns">
            <div>
                <h3>â­• O</h3>
                <ul id="oVoters"></ul>
            </div>
            <div>
                <h3>âŒ X</h3>
                <ul id="xVoters"></ul>
            </div>
        </div>
        <div class="button-group">
            <button id="endVoteEarlyBtn" class="action-button end-early-btn">â° íˆ¬í‘œ ì¡°ê¸° ì¢…ë£Œ</button>
        </div>
    </div>

    <!-- Result Room -->
    <div id="resultRoom" class="panel">
        <h2 id="resultHeader"></h2>
        <p id="resultQuestion" class="question-display"></p>
        <div class="voter-columns">
            <div>
                <h3>â­• O (<span id="oResultCount">0</span>ëª…)</h3>
                <ul id="oResultList"></ul>
            </div>
            <div>
                <h3>âŒ X (<span id="xResultCount">0</span>ëª…)</h3>
                <ul id="xResultList"></ul>
            </div>
        </div>
        <div id="finalizeSection">
            <h3>íŒ¨ìë¥¼ ê²°ì •í•˜ì„¸ìš”!</h3>
            <div class="button-group">
                <button class="action-button finalize-btn" data-choice="O">â­• Oë¥¼ ìµœì¢… ì„ íƒ</button>
                <button class="action-button finalize-btn" data-choice="X">âŒ Xë¥¼ ìµœì¢… ì„ íƒ</button>
            </div>
        </div>
        <div id="nextQuestionSection" style="display: none;">
             <h3>ë²Œì¹™: <span id="penaltyText"></span></h3>
             <p><b id="loserCount">0</b>ëª…ì˜ íŒ¨ìê°€ ê²°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
             <div class="button-group">
                <button id="nextQuestionBtn" class="action-button">â¡ï¸ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ</button>
             </div>
        </div>
    </div>
    
    <!-- Game Finished Room -->
    <div id="gameFinishedRoom" class="panel">
        <h2>ğŸ‰ ê²Œì„ ì¢…ë£Œ!</h2>
        <p>ëª¨ë“  ì§ˆë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
        <div class="button-group">
           <a href="/" class="action-button">ìƒˆ ê²Œì„ ë§Œë“¤ê¸°</a>
        </div>
    </div>

    <div id="message" class="message"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');

        const DOMElements = {
            gameTitle: document.getElementById('gameTitle'),
            qrCode: document.getElementById('qrCode'),
            message: document.getElementById('message'),
            // Rooms
            waitingRoom: document.getElementById('waitingRoom'),
            votingRoom: document.getElementById('votingRoom'),
            resultRoom: document.getElementById('resultRoom'),
            gameFinishedRoom: document.getElementById('gameFinishedRoom'),
            // Waiting Room
            participantCount: document.getElementById('participantCount'),
            participantList: document.getElementById('participantList'),
            startGameBtn: document.getElementById('startGameBtn'),
            // Voting Room
            questionHeader: document.getElementById('questionHeader'),
            currentQuestion: document.getElementById('currentQuestion'),
            timer: document.getElementById('timer'),
            voteCount: document.getElementById('voteCount'),
            oVoters: document.getElementById('oVoters'),
            xVoters: document.getElementById('xVoters'),
            endVoteEarlyBtn: document.getElementById('endVoteEarlyBtn'),
            // Result Room
            resultHeader: document.getElementById('resultHeader'),
            resultQuestion: document.getElementById('resultQuestion'),
            oResultCount: document.getElementById('oResultCount'),
            oResultList: document.getElementById('oResultList'),
            xResultCount: document.getElementById('xResultCount'),
            xResultList: document.getElementById('xResultList'),
            finalizeSection: document.getElementById('finalizeSection'),
            nextQuestionSection: document.getElementById('nextQuestionSection'),
            penaltyText: document.getElementById('penaltyText'),
            loserCount: document.getElementById('loserCount'),
            nextQuestionBtn: document.getElementById('nextQuestionBtn'),
        };

        let statusInterval, timerInterval;

        function showMessage(text, type = 'error') {
            DOMElements.message.textContent = text;
            DOMElements.message.className = `message ${type}`;
            DOMElements.message.style.display = 'block';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`/api/session/${sessionId}/${endpoint}`, options);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'API ìš”ì²­ ì‹¤íŒ¨');
                }
                return await response.json();
            } catch (error) {
                showMessage(error.message);
                return null;
            }
        }

        function updateParticipants(participants = []) {
            DOMElements.participantCount.textContent = participants.length;
            DOMElements.participantList.innerHTML = participants.map(p => `<li>${p}</li>`).join('');
        }
        
        function updateVoters(voters) {
            const oVoterList = voters.O || [];
            const xVoterList = voters.X || [];
            DOMElements.voteCount.textContent = oVoterList.length + xVoterList.length;
            DOMElements.oVoters.innerHTML = oVoterList.map(v => `<li>${v}</li>`).join('');
            DOMElements.xVoters.innerHTML = xVoterList.map(v => `<li>${v}</li>`).join('');
        }

        async function updateTimer() {
            const data = await apiCall('time');
            if (data) {
                if (data.remainingTime > 0) {
                    DOMElements.timer.textContent = data.remainingTime;
                } else {
                    DOMElements.timer.textContent = "0";
                    clearInterval(timerInterval);
                    timerInterval = null;
                    updateStatus(); // Update status immediately when timer ends
                }
            }
        }
        
        function switchRoom(room) {
            ['waitingRoom', 'votingRoom', 'resultRoom', 'gameFinishedRoom'].forEach(r => {
                DOMElements[r].style.display = 'none';
            });
            if (DOMElements[room]) {
                DOMElements[room].style.display = 'block';
            }
        }

        async function updateStatus() {
            const data = await apiCall('result');
            if (!data) return;

            DOMElements.gameTitle.textContent = data.title;

            if (data.gameState === 'waiting') {
                switchRoom('waitingRoom');
                updateParticipants(data.participants);
            } else if (data.gameState === 'voting') {
                switchRoom('votingRoom');
                const qIndex = data.currentQuestionIndex;
                DOMElements.questionHeader.textContent = `ì§ˆë¬¸ ${qIndex + 1} / ${data.totalQuestions}`;
                DOMElements.currentQuestion.textContent = data.question;
                updateVoters(data.voters);
                if (!timerInterval) {
                    updateTimer(); // Initial call
                    timerInterval = setInterval(updateTimer, 1000);
                }
            } else if (data.gameState === 'result') {
                switchRoom('resultRoom');
                const qIndex = data.currentQuestionIndex;
                const penalty = data.penalty;
                DOMElements.resultHeader.textContent = `ì§ˆë¬¸ ${qIndex + 1} ê²°ê³¼`;
                DOMElements.resultQuestion.textContent = data.question;

                const oVoters = data.voters.O || [];
                const xVoters = data.voters.X || [];
                DOMElements.oResultCount.textContent = oVoters.length;
                DOMElements.xResultCount.textContent = xVoters.length;
                DOMElements.oResultList.innerHTML = oVoters.map(v => `<li>${v}</li>`).join('');
                DOMElements.xResultList.innerHTML = xVoters.map(v => `<li>${v}</li>`).join('');

                if (data.isFinalized) {
                    DOMElements.finalizeSection.style.display = 'none';
                    DOMElements.nextQuestionSection.style.display = 'block';
                    const losers = data.finalChoice === 'O' ? xVoters : oVoters;
                    DOMElements.penaltyText.textContent = penalty;
                    DOMElements.loserCount.textContent = losers.length;

                    if (qIndex + 1 >= data.totalQuestions) {
                         DOMElements.nextQuestionBtn.textContent = 'ğŸ† ìµœì¢… ê²°ê³¼ ë³´ê¸°';
                    } else {
                        DOMElements.nextQuestionBtn.textContent = `â¡ï¸ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ (${qIndex + 2}/${data.totalQuestions})`;
                    }
                } else {
                    DOMElements.finalizeSection.style.display = 'block';
                    DOMElements.nextQuestionSection.style.display = 'none';
                }

            } else if (data.gameState === 'finished') {
                switchRoom('gameFinishedRoom');
                clearInterval(statusInterval);
            }
        }

        window.onload = () => {
            if (!sessionId) {
                document.body.innerHTML = '<h1>âŒ ì˜¤ë¥˜: ì„¸ì…˜ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>';
                return;
            }
            DOMElements.qrCode.src = `/api/session/${sessionId}/qr`;
            
            DOMElements.startGameBtn.addEventListener('click', () => apiCall('next', 'POST').then(updateStatus));
            DOMElements.endVoteEarlyBtn.addEventListener('click', () => apiCall('end', 'POST').then(updateStatus));
            DOMElements.nextQuestionBtn.addEventListener('click', () => apiCall('next', 'POST').then(updateStatus));
            
            DOMElements.finalizeSection.addEventListener('click', (e) => {
                if (e.target.classList.contains('finalize-btn')) {
                    const choice = e.target.dataset.choice;
                    apiCall('finalize', 'POST', { choice }).then(updateStatus);
                }
            });

            updateStatus();
            statusInterval = setInterval(updateStatus, 1500);
        };
    </script>
</body>
</html> 